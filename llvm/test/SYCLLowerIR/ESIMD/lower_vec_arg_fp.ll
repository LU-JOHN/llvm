; NOTE: Assertions have been autogenerated by utils/update_test_checks.py
; RUN: opt < %s -passes=ESIMDLowerVecArg -S | FileCheck %s

; This test checks that there is no crash in ESIMDLowerVecArg pass when
; rewriting funcitons that are used through a function pointer.

%"cl::sycl::INTEL::gpu::simd" = type { <64 x i32> }

define dso_local spir_func void @func(ptr %arg) {
; CHECK-LABEL: @func(
; CHECK-NEXT:  entry:
; CHECK-NEXT:    ret void
;
entry:
  ret void
}

define dso_local spir_func void @init_ptr(ptr %foo) !sycl_explicit_simd !1 {
; CHECK-LABEL: @init_ptr(
; CHECK-NEXT:  entry:
; CHECK-NEXT:    store ptr @func, ptr [[FOO:%.*]], align 8
; CHECK-NEXT:    ret void
;
entry:
  store ptr @func, ptr %foo
  ret void
}

define dso_local spir_func void @use_ptr(ptr %foo) !sycl_explicit_simd !1 {
; CHECK-LABEL: @use_ptr(
; CHECK-NEXT:  entry:
; CHECK-NEXT:    [[AGG_TMP:%.*]] = alloca %"cl::sycl::INTEL::gpu::simd", align 256
; CHECK-NEXT:    call spir_func void [[FOO:%.*]](ptr [[AGG_TMP]])
; CHECK-NEXT:    ret void
;
entry:
  %agg.tmp = alloca %"cl::sycl::INTEL::gpu::simd"
  call spir_func void %foo(ptr %agg.tmp)
  ret void
}

define dso_local spir_func void @esimd_kernel() !sycl_explicit_simd !1 {
; CHECK-LABEL: @esimd_kernel(
; CHECK-NEXT:  entry:
; CHECK-NEXT:    [[FP:%.*]] = alloca ptr, align 8
; CHECK-NEXT:    call spir_func void @init_ptr(ptr [[FP]])
; CHECK-NEXT:    [[TMP0:%.*]] = load ptr, ptr [[FP]], align 8
; CHECK-NEXT:    call spir_func void @use_ptr(ptr [[TMP0]])
; CHECK-NEXT:    ret void
;
entry:
  %fp = alloca ptr
  call spir_func void @init_ptr(ptr %fp)
  %0 = load ptr, ptr %fp
  call spir_func void @use_ptr(ptr %0)
  ret void
}

!1 = !{}
